<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>任务a</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            /* 隐藏body窗口区域滚动条 */
        }
    </style>
    <!--引入three.js三维引擎-->
    <script crossorigin="anonymous" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" src="https://lib.baomitu.com/jquery/3.6.0/jquery.js"></script>
    <script src="../three.js/three.js"></script>
    <script src="../three.js/OrbitControls.js"></script>
    <script src="../three.js/MTLLoader.js"></script>
    <script src="../three.js/OBJLoader.js"></script>
</head>

<body>
<script>
    alert("A 前进\nB 后退\nA 左转\nD 右转\n鼠标左右键滚轮控制视角");

    var car,camera;
    var car_alpha = 90;
    var change_alpha = 3;
    var d = 5;
    var yyy = 100;
    var zzz = -150;
    var fz,fy;

    /**
     * 导入obj模型
     * */
    var OBJLoader = new THREE.OBJLoader();
    var MTLLoader = new THREE.MTLLoader();

    // 加载OBJ文件
    // 如果没有材质文件，系统自动设置Phong网格材质
    function loadOBJ() {
        OBJLoader.load('../obj/file.obj', function (obj) {
            car = obj;
            // 初始化模型坐标值（根据需要自行调整）
            // 设置模型缩放比例
            car.position.x = 0;
            car.position.y = 0;
            car.position.z = 0;
            car.scale.set(1, 1, 1);
            // 把模型添加到场景里面
            // car.traverse(function(child) {
            //     if (child instanceof THREE.Mesh) {
            //         //设置模型皮肤
            //         child.material.map = THREE.ImageUtils.loadTexture("obj/3Dxy_Img_3.jpg");
            //     }
            // })
            scene.add(car);
            // setTimeout(animate(), 400);
        }, function () {
            console.log('import OBJ success!');
        }, function (err) {
            console.log('OBJ error!', err);
        });
    }
    loadOBJ();
    MTLLoader.load('../obj/file.mtl', function (materials) {
        // OBJ模型会和MaterialCreator包含的材质相对应
        materials.preload();
        OBJLoader.setMaterials(materials);
        // var materialsDetail = materials.materials;
        // for (var item in materialsDetail) {
        //     materialsDetail[item].opacity = 1;
        // }
        //loadOBJ(materials);
    }, function () {
        console.log('import MTL success!');
    }, function (err) {
        console.log('MTL error!', err);
    });
    $(document).keydown(function(event){
        if(event.keyCode == 87){//前进
            car.position.z += Math.sin(car_alpha/180*Math.PI)*d;
            // console.log(Math.sin(car_alpha/180*Math.PI)*5);
            car.position.x -= Math.cos(car_alpha/180*Math.PI)*d;

            camera.position.x = car.position.x + Math.cos((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.z = car.position.z + Math.sin((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.y = yyy;
            console.log(camera.position.x);
            console.log(camera.position.z);
            camera.lookAt(car.position);
            // var xx = car.position.x;
            // var yy = car.position.y;
            // var zz = car.position.z;
            // // camera.position.x = camera.position.y = camera.position.z = 0;
            // // camera.rotateY(change_alpha/180*Math.PI)
            // camera.position.x = Math.cos((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.x)
            // // camera.position.y = ;
            // camera.position.z = Math.sin((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.z)
            // camera.lookAt(car.position);

            // camera.position.z += 5;
        }
        if(event.keyCode == 83){//后退
            car.position.z -= Math.sin((180-car_alpha)/180*Math.PI)*d;
            // console.log(Math.sin(car_alpha/180*Math.PI)*5);
            car.position.x += Math.cos((180-car_alpha+180)/180*Math.PI)*d;

            camera.position.x = car.position.x + Math.cos((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.z = car.position.z + Math.sin((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.y = yyy;
            console.log(camera.position.x);
            console.log(camera.position.z);
            camera.lookAt(car.position);

            // var xx = car.position.x;
            // var yy = car.position.y;
            // var zz = car.position.z;
            // // camera.position.x = camera.position.y = camera.position.z = 0;
            // // camera.rotateY(change_alpha/180*Math.PI)
            // camera.position.x = Math.cos((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.x)
            // // camera.position.y = ;
            // camera.position.z = Math.sin((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.z)
            // camera.lookAt(car.position);

            // camera.position.z -= d;
        }
        if(event.keyCode == 65){//左转
            car_alpha += change_alpha;
            car_alpha = (car_alpha+360) % 360;
            var x = car.position.x;
            var y = car.position.y;
            var z = car.position.z;
            car.position.x = car.position.y = car.position.z = 0;
            car.rotateY(change_alpha/180*Math.PI)
            car.position.x = x;
            car.position.y = y;
            car.position.z = z;

            camera.position.x = car.position.x + Math.cos((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.z = car.position.z + Math.sin((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.y = yyy;
            console.log(camera.position.x);
            console.log(camera.position.z);
            camera.lookAt(car.position);

            // var xx = car.position.x;
            // var yy = car.position.y;
            // var zz = car.position.z;
            // // camera.position.x = camera.position.y = camera.position.z = 0;
            // // camera.rotateY(change_alpha/180*Math.PI)
            // camera.position.x = Math.cos((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.x)
            // // camera.position.y = ;
            // camera.position.z = Math.sin((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.z)
            // camera.lookAt(car.position);
        }
        if(event.keyCode == 68){//右转
            car_alpha -= change_alpha;
            if(car_alpha <= 360) {
                car_alpha += 360;
            }
            var x = car.position.x;
            var y = car.position.y;
            var z = car.position.z;
            car.position.x = car.position.y =car.position.z = 0;
            car.rotateY((360-change_alpha)/180*Math.PI)
            car.position.x = x;
            car.position.y = y;
            car.position.z = z;

            camera.position.x = car.position.x + Math.cos((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.z = car.position.z + Math.sin((180-car_alpha)/180*Math.PI)*zzz;
            camera.position.y = yyy;
            console.log(camera.position.x);
            console.log(camera.position.z);
            camera.lookAt(car.position);


            //
            // var xx = car.position.x;
            // var yy = car.position.y;
            // var zz = car.position.z;
            // // camera.position.x = camera.position.y = camera.position.z = 0;
            // // camera.rotateY(change_alpha/180*Math.PI)
            // camera.position.x = Math.cos((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.x)
            // // camera.position.y = ;
            // camera.position.z = Math.sin((180-car_alpha)/180*Math.PI)*(-500);
            // console.log(camera.position.z)
            // camera.lookAt(car.position);

        }
        // camera.lookAt(car.position); //设置相机方向(指向的场景对象)
    });
    //
    //
    // var loader = new THREE.FBXLoader();
    // loader.load( 'obj/fbx/bmw-4-series-convertible-2021.fbx', function ( object )
    // {//加载路径fbx文件
    //     object.scale.set(5,5,5);
    //     object.traverse( function ( child )
    //     {
    //         if ( child.isMesh )
    //         {
    //
    //             child.castShadow = true;
    //             child.receiveShadow = true;
    //
    //         }
    //
    //     } );
    //     scene.add( object );//模型
    //
    // } );
    /**
     * 创建场景对象Scene
     */
    var scene = new THREE.Scene();
    var axisHelper = new THREE.AxisHelper(250);
    scene.add(axisHelper);


    /**
     * 创建网格模型
     */
        // var geometry = new THREE.SphereGeometry(60, 40, 40); //创建一个球体几何对象
    var geometry = new THREE.BoxGeometry(3000, 20, 3000); //创建一个立方体几何对象Geometry
    geometry.translate(0,-10,0);
    var line1 = new THREE.BoxGeometry(200, 19, 10); //创建一个立方体几何对象Geometry
    line1.translate(-400,-9,-400);
    var line2 = new THREE.BoxGeometry(200, 19, 10); //创建一个立方体几何对象Geometry
    line2.translate(-400,-9,-300);

    var material = new THREE.MeshLambertMaterial({
        color: 0xffffff
    }); //材质对象Material
    var color = new THREE.MeshLambertMaterial({
        color: 0xff0000
    }); //材质对象Material
    var mesh = new THREE.Mesh(geometry, material); //网格模型对象Mesh
    var LINE1 = new THREE.Mesh(line1, color); //网格模型对象Mesh
    var LINE2 = new THREE.Mesh(line2, color); //网格模型对象Mesh
    scene.add(mesh); //网格模型添加到场景中
    scene.add(LINE1); //网格模型添加到场景中
    scene.add(LINE2); //网格模型添加到场景中

    /**
     * 光源设置
     */
        //点光源
    var point = new THREE.PointLight(0xffffff);
    point.position.set(200, 500, 200); //点光源位置
    scene.add(point); //点光源添加到场景中
    //环境光
    var ambient = new THREE.AmbientLight(0x444444);
    // scene.add(ambient);
    // console.log(scene)
    // console.log(scene.children)
    /**
     * 相机设置
     */
    var width = window.innerWidth; //窗口宽度
    var height = window.innerHeight; //窗口高度
    var k = width / height; //窗口宽高比
    var s = 300; //三维场景显示范围控制系数，系数越大，显示的范围越大
    //创建相机对象
    camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 100000 );
    camera.position.set(0, yyy, zzz); //设置相机位置
    camera.lookAt(scene.position); //设置相机方向(指向的场景对象)



    /**
     * 创建渲染器对象
     */
    var renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(width, height);//设置渲染区域尺寸
    renderer.setClearColor(0xb9d3ff, 1); //设置背景颜色
    document.body.appendChild(renderer.domElement); //body元素中插入canvas对象
    //执行渲染操作  指定场景 、相机作为参数
    // function render() {
    //     renderer.render(scene,camera);//执行渲染操作
    //     mesh.rotateX(0.01);//每次绕y轴旋转0.01弧度
    //     // mesh.translateY(0.1);
    //     requestAnimationFrame(render);//请求再次执行渲染函数render
    // }
    // render();
    function render() {
        requestAnimationFrame(render);
        renderer.render(scene,camera);//执行渲染操作
    }
    render();
    var controls = new THREE.OrbitControls(camera,renderer.domElement);//创建控件对象
    // controls.addEventListener('change', render);//监听鼠标、键盘事件
</script>
</body>
</html>
